<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel de Administración</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; height: 100%; font-size: 11pt; display: flex; flex-direction: column; }
            .printable-area .print-body { flex-grow: 1; }
            .printable-area .print-footer { flex-shrink: 0; margin-top: auto; }
            .printable-area table tr { border-bottom: 1px solid #ccc; }
            @page { size: A4; margin: 10mm; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const API_URL = 'https://distriapi.onzacore.site/api';

        // --- Componentes de Iconos ---
        const HomeIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const PackageIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16.5 9.4a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z"/><path d="M19 13.3a9 9 0 1 1-14 0"/><path d="M12 17.5a2.5 2.5 0 0 1-2.5-2.5V9.4h5v5.6a2.5 2.5 0 0 1-2.5 2.5Z"/></svg>);
        const UsersIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>);
        const LogOutIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>);
        const Spinner = ({ className }) => (<div className={`animate-spin rounded-full h-8 w-8 border-b-2 ${className || 'border-white'}`}></div>);
        const CloseIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>);
        const PlusIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>);
        const PrintIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>);
        const ShoppingCartIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>);
        const HistoryIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>);
        const SortIcon = ({ direction }) => {
            if (!direction) return <svg width="16" height="16" viewBox="0 0 16 16" className="inline-block ml-1 text-gray-400"><path fill="currentColor" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5zM4.5 1a.5.5 0 0 0-.5.5v11.793l-3.146-3.147a.5.5 0 0 0-.708.708l4 4a.5.5 0 0 0 .708 0l4-4a.5.5 0 0 0-.708-.708L5 13.293V1.5a.5.5 0 0 0-.5-.5z"/></svg>;
            if (direction === 'ascending') return <svg width="16" height="16" viewBox="0 0 16 16" className="inline-block ml-1"><path fill="currentColor" d="M7.247 4.86l-4.796 5.481c-.566.647-.106 1.659.753 1.659h9.592a1 1 0 0 0 .753-1.659l-4.796-5.48a1 1 0 0 0-1.506 0z"/></svg>;
            return <svg width="16" height="16" viewBox="0 0 16 16" className="inline-block ml-1"><path fill="currentColor" d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>;
        };
        const TrashIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>);
        const WarningIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>);
        const ActivityIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>);
        const DownloadIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>);
        const UploadIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>);
        const UserPlusIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>);
        const CheckSquareIcon = (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>);

        const PasswordConfirmModal = ({ title, message, onConfirm, onClose, loading }) => {
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');
            const token = localStorage.getItem('token');

            const handleConfirm = async () => {
                setError('');
                if (!password) {
                    setError('La contraseña es requerida.');
                    return;
                }
                try {
                    const response = await fetch(`${API_URL}/auth/reauthenticate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ password })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Contraseña incorrecta.');
                    onConfirm();
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md">
                        <div className="p-6">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <p className="text-gray-600 mt-2">{message}</p>
                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700">Confirma tu contraseña</label>
                                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"/>
                                {error && <p className="text-red-500 text-xs mt-1">{error}</p>}
                            </div>
                        </div>
                        <div className="p-4 bg-gray-50 flex justify-end items-center gap-4 rounded-b-xl">
                            <button onClick={onClose} className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button onClick={handleConfirm} disabled={loading} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">{loading ? 'Confirmando...' : 'Confirmar'}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LoginPage = ({ onLogin, loading, error }) => {
          const [email, setEmail] = React.useState('');
          const [password, setPassword] = React.useState('');
          const handleSubmit = (e) => { e.preventDefault(); onLogin(email, password); };
          return (
            <div className="min-h-screen bg-gray-100 flex flex-col justify-center items-center font-sans">
              <div className="w-full max-w-md bg-white rounded-xl shadow-lg p-8">
                <h1 className="text-3xl font-bold text-center text-gray-800 mb-2">Panel de Control</h1>
                <p className="text-center text-gray-500 mb-8">Inicia sesión para continuar</p>
                <form onSubmit={handleSubmit}>
                  <div className="mb-4"><label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="email">Correo Electrónico</label><input id="email" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="juan@distribuidora.com" className="w-full px-4 py-3 rounded-lg bg-gray-200 focus:border-blue-500 focus:bg-white focus:outline-none" required /></div>
                  <div className="mb-6"><label className="block text-gray-700 text-sm font-bold mb-2" htmlFor="password">Contraseña</label><input id="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="••••••••••" className="w-full px-4 py-3 rounded-lg bg-gray-200 focus:border-blue-500 focus:bg-white focus:outline-none" required /></div>
                  {error && <p className="text-red-500 text-xs italic mb-4">{error}</p>}
                  <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">{loading ? <Spinner /> : 'Ingresar'}</button>
                </form>
              </div>
            </div>
          );
        };
        
        const DashboardView = ({ onShowImportVentasModal }) => {
            const [stats, setStats] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [salesPeriod, setSalesPeriod] = React.useState('7d');
            const [topProductsLimit, setTopProductsLimit] = React.useState(5);
            const [dataSource, setDataSource] = React.useState('pedidos');
            const token = localStorage.getItem('token');
            const chartInstances = React.useRef({});

            const fetchStats = React.useCallback(async () => {
                setLoading(true); setError(null); setStats(null);
                try {
                    const url = `${API_URL}/dashboard/stats?source=${dataSource}&salesPeriod=${salesPeriod}&topProductsLimit=${topProductsLimit}`;
                    const response = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.message || 'No se pudieron cargar las estadísticas.');
                    }
                    setStats(await response.json());
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            }, [token, salesPeriod, topProductsLimit, dataSource]);

            React.useEffect(() => {
                fetchStats();
                return () => { Object.values(chartInstances.current).forEach(chart => chart.destroy()); };
            }, [fetchStats]);
            
            React.useEffect(() => {
                if (stats) {
                    Object.values(chartInstances.current).forEach(chart => chart.destroy());
                    chartInstances.current = {};
                    
                    const salesCtx = document.getElementById('salesChart');
                    if (salesCtx) {
                        const isMonthly = salesPeriod === 'monthly';
                        chartInstances.current.salesChart = new Chart(salesCtx, { type: 'line', data: { labels: isMonthly ? stats.salesByDay.map(d => d.saleMonth) : stats.salesByDay.map(d => new Date(d.saleDate).toLocaleDateString()), datasets: [{ label: `Ingresos (${isMonthly ? 'por Mes' : 'por Día'})`, data: isMonthly ? stats.salesByDay.map(d => d.monthlyRevenue) : stats.salesByDay.map(d => d.dailyRevenue), borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.5)', fill: true, tension: 0.1 }] } });
                    }
                    const productsCtx = document.getElementById('productsChart');
                    if (productsCtx) {
                        chartInstances.current.productsChart = new Chart(productsCtx, { type: 'bar', data: { labels: stats.topProducts.map(p => p.nombre), datasets: [{ label: 'Unidades Vendidas', data: stats.topProducts.map(p => p.totalQuantity), backgroundColor: ['rgba(239, 68, 68, 0.7)', 'rgba(249, 115, 22, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(132, 204, 22, 0.7)', 'rgba(34, 197, 94, 0.7)'] }] }, options: { indexAxis: 'y', plugins: { legend: { display: false } } } });
                    }
                    const customersCtx = document.getElementById('customersChart');
                    if (customersCtx && stats.topCustomers && stats.topCustomers.length > 0) {
                         chartInstances.current.customersChart = new Chart(customersCtx, { type: 'doughnut', data: { labels: stats.topCustomers.map(c => c.nombre_comercio), datasets: [{ label: 'Monto Comprado', data: stats.topCustomers.map(c => c.totalSpent), backgroundColor: ['#4c51bf', '#667eea', '#7f9cf5', '#a3bffa', '#c3dafe'] }] } });
                    }
                }
            }, [stats, salesPeriod]);

            const StatCard = ({ title, value, icon }) => ( <div className="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4"><div className="bg-blue-100 p-3 rounded-full">{icon}</div><div><p className="text-gray-500 text-sm">{title}</p><p className="text-2xl font-bold text-gray-800">{value}</p></div></div> );

            return (
                <div className="space-y-8">
                    <div className="flex justify-between items-center flex-wrap gap-4">
                        <div><h1 className="text-3xl font-bold text-gray-800">Dashboard</h1><p className="text-gray-500">Resumen general de la actividad.</p></div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 bg-gray-200 p-1 rounded-lg"><button onClick={() => setDataSource('pedidos')} className={`px-3 py-1 text-sm font-semibold rounded-md transition-colors ${dataSource === 'pedidos' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>Pedidos App</button><button onClick={() => setDataSource('presencial')} className={`px-3 py-1 text-sm font-semibold rounded-md transition-colors ${dataSource === 'presencial' ? 'bg-white shadow text-blue-600' : 'text-gray-600'}`}>Ventas Presenciales</button></div>
                            <button onClick={onShowImportVentasModal} className="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0"><UploadIcon className="h-5 w-5 mr-2" /> Importar</button>
                        </div>
                    </div>
                    
                    {loading && <div className="flex justify-center p-10"><Spinner className="border-blue-500 h-10 w-10" /></div>}
                    {error && <div className="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert"><p className="font-bold">Error</p><p>{error}</p></div>}
                    
                    {stats && (
                        <div className="space-y-8">
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <StatCard title="Ingresos Totales" value={`$${parseFloat(stats.totalRevenue).toLocaleString('es-AR')}`} icon={<UsersIcon className="h-6 w-6 text-blue-600" />} />
                                <StatCard title="Pedidos/Ventas Totales" value={stats.totalOrders} icon={<ShoppingCartIcon className="h-6 w-6 text-blue-600" />} />
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white p-6 rounded-xl shadow-lg">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Ventas</h3><div className="flex gap-1 bg-gray-100 p-1 rounded-lg"><button onClick={() => setSalesPeriod('7d')} className={`px-2 py-1 text-xs font-bold rounded-md ${salesPeriod === '7d' ? 'bg-white shadow' : 'text-gray-500'}`}>7 Días</button><button onClick={() => setSalesPeriod('30d')} className={`px-2 py-1 text-xs font-bold rounded-md ${salesPeriod === '30d' ? 'bg-white shadow' : 'text-gray-500'}`}>30 Días</button><button onClick={() => setSalesPeriod('monthly')} className={`px-2 py-1 text-xs font-bold rounded-md ${salesPeriod === 'monthly' ? 'bg-white shadow' : 'text-gray-500'}`}>Por Mes</button></div></div>
                                    <canvas id="salesChart"></canvas>
                                </div>
                                <div className="bg-white p-6 rounded-xl shadow-lg">
                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg">Productos Más Vendidos</h3><div className="flex gap-1 bg-gray-100 p-1 rounded-lg"><button onClick={() => setTopProductsLimit(5)} className={`px-2 py-1 text-xs font-bold rounded-md ${topProductsLimit === 5 ? 'bg-white shadow' : 'text-gray-500'}`}>Top 5</button><button onClick={() => setTopProductsLimit(10)} className={`px-2 py-1 text-xs font-bold rounded-md ${topProductsLimit === 10 ? 'bg-white shadow' : 'text-gray-500'}`}>Top 10</button><button onClick={() => setTopProductsLimit(20)} className={`px-2 py-1 text-xs font-bold rounded-md ${topProductsLimit === 20 ? 'bg-white shadow' : 'text-gray-500'}`}>Top 20</button></div></div>
                                    <canvas id="productsChart"></canvas>
                                </div>
                            </div>
                            {dataSource === 'pedidos' && stats.topCustomers && stats.salesBySeller && (
                                <div className="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                    <div className="lg:col-span-3 bg-white rounded-xl shadow-lg"><h3 className="font-bold text-lg p-6">Rendimiento por Vendedor</h3><div className="overflow-x-auto"><table className="min-w-full"><thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendedor</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Pedidos</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Vendido</th></tr></thead><tbody className="divide-y divide-gray-200">{stats.salesBySeller.map(seller => (<tr key={seller.nombre}><td className="px-6 py-4 font-medium text-gray-900">{seller.nombre}</td><td className="px-6 py-4 text-gray-700">{seller.orderCount}</td><td className="px-6 py-4 text-gray-700">${parseFloat(seller.totalSold).toLocaleString('es-AR')}</td></tr>))}</tbody></table></div></div>
                                    <div className="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg"><h3 className="font-bold text-lg mb-4">Top 5 Clientes (por Monto)</h3><canvas id="customersChart"></canvas></div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        const NavItem = ({ icon, text, active, onClick }) => (<a href="#" onClick={onClick} className={`flex items-center px-4 py-3 rounded-lg transition-colors duration-200 ${ active ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white' }`}><span className="mr-3">{icon}</span><span className="font-medium">{text}</span></a>);
        
        const EstadoBadge = ({ estado }) => {
            const estados = { pendiente: 'Pendiente', visto: 'Visto', en_preparacion: 'En Preparación', facturado: 'Facturado', listo_para_entrega: 'Listo p/ Entrega', entregado: 'Entregado', cancelado: 'Cancelado', archivado: 'Archivado' };
            const styles = { pendiente: 'bg-yellow-100 text-yellow-800', visto: 'bg-blue-100 text-blue-800', en_preparacion: 'bg-indigo-100 text-indigo-800', entregado: 'bg-green-100 text-green-800', listo_para_entrega: 'bg-purple-100 text-purple-800', facturado: 'bg-gray-200 text-gray-800', cancelado: 'bg-red-100 text-red-800', archivado: 'bg-gray-400 text-white' };
            return (<span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${styles[estado] || 'bg-gray-100 text-gray-800'}`}>{estados[estado] || estado}</span>);
        };
        
        const TableHeader = ({ children, sortKey, sortConfig, onSort }) => (<th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onClick={() => onSort(sortKey)}>{children}{sortConfig.key === sortKey ? <SortIcon direction={sortConfig.direction} /> : <SortIcon />}</th>);
        
        const useSortableData = (items, config = null) => {
            const [sortConfig, setSortConfig] = React.useState(config);
            const sortedItems = React.useMemo(() => {
                let sortableItems = [...items];
                if (sortConfig !== null) {
                    sortableItems.sort((a, b) => {
                        if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'ascending' ? -1 : 1;
                        if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'ascending' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [items, sortConfig]);
            const requestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig && sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };
            return { items: sortedItems, requestSort, sortConfig };
        };
        
        const PedidosView = ({ onSelectPedido, user }) => {
            const [pedidos, setPedidos] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [showArchived, setShowArchived] = React.useState(false);
            const [confirmAction, setConfirmAction] = React.useState({ action: null, pedido: null });
            const token = localStorage.getItem('token');
            const { items: sortedPedidos, requestSort, sortConfig } = useSortableData(pedidos, { key: 'id', direction: 'descending' });
            
            const fetchPedidos = React.useCallback(async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/pedidos`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) throw new Error('No se pudo obtener la lista de pedidos.');
                    setPedidos(await response.json());
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            }, [token]);

            React.useEffect(() => { fetchPedidos(); }, [fetchPedidos]);

            const handleActionConfirm = async () => {
                const { action, pedido } = confirmAction;
                if (!action || !pedido) return;
                
                const url = `${API_URL}/pedidos/${pedido.id}/${action}`;
                
                try {
                    await fetch(url, { method: 'PUT', headers: { 'Authorization': `Bearer ${token}` } });
                    setConfirmAction({ action: null, pedido: null });
                    fetchPedidos();
                } catch(err) {
                    alert(`Error al ejecutar la acción: ${err.message}`);
                    setConfirmAction({ action: null, pedido: null });
                }
            };

            const filteredPedidos = sortedPedidos.filter(p => (showArchived ? p.estado === 'archivado' : p.estado !== 'archivado') && (p.nombre_comercio.toLowerCase().includes(searchTerm.toLowerCase()) || p.nombre_vendedor.toLowerCase().includes(searchTerm.toLowerCase()) || p.id.toString().includes(searchTerm)));
            
            return (
                <div>
                    {confirmAction.action && (
                        <PasswordConfirmModal 
                            title={`¿${confirmAction.action === 'archive' ? 'Archivar' : 'Desarchivar'} Pedido #${confirmAction.pedido.id}?`} 
                            message={confirmAction.action === 'archive' ? 'El pedido se ocultará de la lista principal.' : 'El pedido volverá a la lista de pedidos activos.'}
                            onConfirm={handleActionConfirm} 
                            onClose={() => setConfirmAction({ action: null, pedido: null })} 
                        />
                    )}
                    <div className="flex justify-between items-center mb-6 gap-4">
                        <h1 className="text-3xl font-bold text-gray-800">Bandeja de Pedidos</h1>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2">
                                <span className="text-sm text-gray-600">Archivados</span>
                                <button onClick={() => setShowArchived(!showArchived)} className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${showArchived ? 'bg-blue-600' : 'bg-gray-200'}`}>
                                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${showArchived ? 'translate-x-6' : 'translate-x-1'}`}/>
                                </button>
                            </div>
                            <input type="text" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full max-w-sm px-4 py-2 border border-gray-300 rounded-lg"/>
                        </div>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            {loading ? <div className="p-6 flex justify-center"><Spinner className="border-blue-500"/></div> : error ? <p className="p-6 text-red-500">{error}</p> : (
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50"><tr><TableHeader sortKey="id" sortConfig={sortConfig} onSort={requestSort}>ID</TableHeader><TableHeader sortKey="nombre_comercio" sortConfig={sortConfig} onSort={requestSort}>Cliente</TableHeader><TableHeader sortKey="nombre_vendedor" sortConfig={sortConfig} onSort={requestSort}>Vendedor</TableHeader><TableHeader sortKey="fecha_creacion" sortConfig={sortConfig} onSort={requestSort}>Fecha</TableHeader><TableHeader sortKey="estado" sortConfig={sortConfig} onSort={requestSort}>Estado</TableHeader><th className="relative px-6 py-3"></th></tr></thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredPedidos.map((pedido) => (
                                            <tr key={pedido.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 text-sm font-medium text-gray-900">#{pedido.id}</td><td className="px-6 py-4 text-sm text-gray-700">{pedido.nombre_comercio}</td>
                                                <td className="px-6 py-4 text-sm text-gray-700">{pedido.nombre_vendedor}</td><td className="px-6 py-4 text-sm text-gray-700">{new Date(pedido.fecha_creacion).toLocaleDateString()}</td>
                                                <td className="px-6 py-4 text-sm capitalize"><EstadoBadge estado={pedido.estado} /></td>
                                                <td className="px-6 py-4 text-right text-sm font-medium space-x-4">
                                                    <button onClick={() => onSelectPedido(pedido.id)} className="text-blue-600 hover:text-blue-900">Ver</button>
                                                    {user.rol === 'admin' && pedido.estado !== 'archivado' && (<button onClick={() => setConfirmAction({ action: 'archive', pedido: pedido })} className="text-gray-500 hover:text-red-700">Archivar</button>)}
                                                    {user.rol === 'admin' && pedido.estado === 'archivado' && (<button onClick={() => setConfirmAction({ action: 'unarchive', pedido: pedido })} className="text-green-600 hover:text-green-800">Desarchivar</button>)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                            {!loading && filteredPedidos.length === 0 && <p className="p-6 text-center text-gray-500">No se encontraron resultados.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        
        const ProductosView = ({ user, onShowProductoForm, onShowImportModal }) => {
            const [productos, setProductos] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState('');
            const token = localStorage.getItem('token');
            const { items: sortedProductos, requestSort, sortConfig } = useSortableData(productos, { key: 'nombre', direction: 'ascending' });
            const fetchProductos = React.useCallback(async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/productos`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) throw new Error('No se pudo obtener la lista de productos.');
                    setProductos(await response.json());
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            }, [token]);
            React.useEffect(() => { fetchProductos(); }, [fetchProductos]);
            const handleDelete = async (productoId) => {
                if (window.confirm('¿Estás seguro de que quieres eliminar este producto?')) {
                    try {
                        const response = await fetch(`${API_URL}/productos/${productoId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        if (!response.ok) throw new Error('Error al eliminar el producto.');
                        fetchProductos();
                    } catch (err) { alert(err.message); }
                }
            };
            const handleExport = () => {
                const headers = "codigo_sku,nombre,precio_unitario,stock\n";
                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers 
                    + productos.map(p => `${p.codigo_sku || ''},"${p.nombre.replace(/"/g, '""')}",${p.precio_unitario},${p.stock}`).join("\n");
                
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "productos.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            const filteredProductos = sortedProductos.filter(p => p.nombre.toLowerCase().includes(searchTerm.toLowerCase()) || (p.codigo_sku && p.codigo_sku.toLowerCase().includes(searchTerm.toLowerCase())));
            const isAdmin = user.rol === 'admin';
            return (
                <div>
                    <div className="flex justify-between items-center mb-6 gap-4">
                        <h1 className="text-3xl font-bold text-gray-800">Gestión de Productos</h1>
                        <input type="text" placeholder="Buscar por nombre o SKU..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-lg"/>
                        <div className="flex gap-2">
                            {isAdmin && <button onClick={onShowImportModal} className="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0"><UploadIcon className="h-5 w-5 mr-2" /> Importar</button>}
                            <button onClick={handleExport} className="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0"><DownloadIcon className="h-5 w-5 mr-2" /> Exportar</button>
                            {isAdmin && (<button onClick={() => onShowProductoForm({})} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0"><PlusIcon className="h-5 w-5 mr-2" /> Agregar</button>)}
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            {loading && <div className="p-6 flex justify-center"><Spinner className="border-blue-500"/></div>}
                            {error && <p className="p-6 text-red-500">{error}</p>}
                            {!loading && !error && (
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50"><tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Imagen</th>
                                        <TableHeader sortKey="nombre" sortConfig={sortConfig} onSort={requestSort}>Nombre</TableHeader>
                                        <TableHeader sortKey="precio_unitario" sortConfig={sortConfig} onSort={requestSort}>Precio</TableHeader>
                                        <TableHeader sortKey="stock" sortConfig={sortConfig} onSort={requestSort}>Stock</TableHeader>
                                        {isAdmin && <th className="relative px-6 py-3"><span className="sr-only">Acciones</span></th>}
                                    </tr></thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredProductos.map((producto) => (
                                            <tr key={producto.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4"><img src={producto.imagen_url || 'https://placehold.co/400x400/e2e8f0/e2e8f0?text=...'} alt={producto.nombre} className="h-12 w-12 rounded-md object-cover" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/400x400/e2e8f0/e2e8f0?text=...'; }} /></td>
                                                <td className="px-6 py-4 text-sm font-medium text-gray-900">{producto.nombre}</td><td className="px-6 py-4 text-sm text-gray-700">${producto.precio_unitario}</td>
                                                <td className="px-6 py-4 text-sm text-gray-700">{producto.stock}</td>
                                                {isAdmin && <td className="px-6 py-4 text-right text-sm font-medium space-x-4"><a href="#" onClick={(e) => { e.preventDefault(); onShowProductoForm(producto); }} className="text-blue-600 hover:text-blue-900">Editar</a><a href="#" onClick={(e) => { e.preventDefault(); handleDelete(producto.id); }} className="text-red-600 hover:text-red-900">Eliminar</a></td>}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                            {!loading && filteredProductos.length === 0 && <p className="p-6 text-center text-gray-500">No se encontraron resultados.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        const ClientesView = ({ user, onShowClienteForm }) => {
            const [clientes, setClientes] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [searchTerm, setSearchTerm] = React.useState('');
            const token = localStorage.getItem('token');
            const { items: sortedClientes, requestSort, sortConfig } = useSortableData(clientes, { key: 'nombre_comercio', direction: 'ascending' });
            const fetchClientes = React.useCallback(async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/clientes`, { headers: { 'Authorization': `Bearer ${token}` } });
                    if (!response.ok) throw new Error('No se pudo obtener la lista de clientes.');
                    setClientes(await response.json());
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            }, [token]);
            React.useEffect(() => { fetchClientes(); }, [fetchClientes]);
            const handleDelete = async (clienteId) => {
                if (window.confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
                    try {
                        const response = await fetch(`${API_URL}/clientes/${clienteId}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                        if (!response.ok) throw new Error('Error al eliminar el cliente.');
                        fetchClientes();
                    } catch (err) { alert(err.message); }
                }
            };
            const filteredClientes = sortedClientes.filter(c => c.nombre_comercio.toLowerCase().includes(searchTerm.toLowerCase()) || (c.nombre_contacto && c.nombre_contacto.toLowerCase().includes(searchTerm.toLowerCase())));
            const isAdmin = user.rol === 'admin';
            return (
                <div>
                    <div className="flex justify-between items-center mb-6 gap-4"><h1 className="text-3xl font-bold text-gray-800">Gestión de Clientes</h1><input type="text" placeholder="Buscar por comercio o contacto..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full max-w-xs px-4 py-2 border border-gray-300 rounded-lg"/>{isAdmin && (<button onClick={() => onShowClienteForm({})} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center shrink-0"><PlusIcon className="h-5 w-5 mr-2" /> Agregar</button>)}</div>
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            {loading && <div className="p-6 flex justify-center"><Spinner className="border-blue-500"/></div>}
                            {error && <p className="p-6 text-red-500">{error}</p>}
                            {!loading && !error && (
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50"><tr>
                                        <TableHeader sortKey="nombre_comercio" sortConfig={sortConfig} onSort={requestSort}>Comercio</TableHeader>
                                        <TableHeader sortKey="nombre_contacto" sortConfig={sortConfig} onSort={requestSort}>Contacto</TableHeader>
                                        <TableHeader sortKey="telefono" sortConfig={sortConfig} onSort={requestSort}>Teléfono</TableHeader>
                                        {isAdmin && <th className="relative px-6 py-3"><span className="sr-only">Acciones</span></th>}
                                    </tr></thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {filteredClientes.map((cliente) => (
                                            <tr key={cliente.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 text-sm font-medium text-gray-900">{cliente.nombre_comercio}</td><td className="px-6 py-4 text-sm text-gray-700">{cliente.nombre_contacto}</td>
                                                <td className="px-6 py-4 text-sm text-gray-700">{cliente.telefono}</td>
                                                {isAdmin && <td className="px-6 py-4 text-right text-sm font-medium space-x-4"><a href="#" onClick={(e) => { e.preventDefault(); onShowClienteForm(cliente); }} className="text-blue-600 hover:text-blue-900">Editar</a><a href="#" onClick={(e) => { e.preventDefault(); handleDelete(cliente.id); }} className="text-red-600 hover:text-red-900">Eliminar</a></td>}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                            {!loading && filteredClientes.length === 0 && <p className="p-6 text-center text-gray-500">No se encontraron resultados.</p>}
                        </div>
                    </div>
                </div>
            );
        };
        
        const UsuariosView = ({ onShowUsuarioForm }) => {
            const [users, setUsers] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [confirmDelete, setConfirmDelete] = React.useState(null);
            const token = localStorage.getItem('token');

            const fetchUsers = React.useCallback(async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${API_URL}/usuarios`, { headers: { 'Authorization': `Bearer ${token}` } });
                    setUsers(await response.json());
                } finally {
                    setLoading(false);
                }
            }, [token]);

            React.useEffect(() => { fetchUsers(); }, [fetchUsers]);

            const handleDelete = async () => {
                try {
                    await fetch(`${API_URL}/usuarios/${confirmDelete.id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
                    setConfirmDelete(null);
                    fetchUsers();
                } catch (err) {
                    alert("Error al eliminar el usuario.");
                    setConfirmDelete(null);
                }
            };

            return (
                <div>
                    {confirmDelete && (
                        <PasswordConfirmModal
                            title={`¿Eliminar a ${confirmDelete.nombre}?`}
                            message="Esta acción es irreversible. Todos los datos asociados a este usuario se perderán."
                            onConfirm={handleDelete}
                            onClose={() => setConfirmDelete(null)}
                        />
                    )}
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-gray-800">Gestión de Usuarios</h1>
                        <button onClick={() => onShowUsuarioForm({})} className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg flex items-center"><UserPlusIcon className="h-5 w-5 mr-2" /> Agregar Usuario</button>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rol</th><th className="relative px-6 py-3"></th></tr></thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {users.map(user => (
                                    <tr key={user.id}>
                                        <td className="px-6 py-4 font-medium">{user.nombre}</td>
                                        <td className="px-6 py-4 text-gray-600">{user.email}</td>
                                        <td className="px-6 py-4 text-gray-600 capitalize">{user.rol}</td>
                                        <td className="px-6 py-4 text-right space-x-4">
                                            <button onClick={() => onShowUsuarioForm(user)} className="text-blue-600 hover:text-blue-900">Editar</button>
                                            <button onClick={() => setConfirmDelete(user)} className="text-red-600 hover:text-red-900">Eliminar</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ActividadView = () => {
            const [logs, setLogs] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const token = localStorage.getItem('token');
            React.useEffect(() => {
                const fetchLogs = async () => {
                    try {
                        const response = await fetch(`${API_URL}/logs`, { headers: { 'Authorization': `Bearer ${token}` } });
                        if (!response.ok) throw new Error('No se pudo obtener el registro de actividad.');
                        setLogs(await response.json());
                    } catch (err) { console.error(err); } finally { setLoading(false); }
                };
                fetchLogs();
            }, [token]);
            return (
                <div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-6">Registro de Actividad</h1>
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        {loading ? <p className="p-4">Cargando...</p> : (
                            <ul className="divide-y divide-gray-200">
                                {logs.map(log => (
                                    <li key={log.id} className="p-4">
                                        <p><span className="font-bold">{log.nombre_usuario}</span> {log.accion.toLowerCase().replace(/_/g, ' ')}</p>
                                        <p className="text-sm text-gray-600">{log.detalle}</p>
                                        <p className="text-xs text-gray-400 mt-1">{new Date(log.fecha_creacion).toLocaleString()}</p>
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                </div>
            );
        };
        
        const PedidoDetailModal = ({ pedidoId, onClose, user, onUpdate }) => {
            const [pedido, setPedido] = React.useState(null);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);
            const [isEditing, setIsEditing] = React.useState(false);
            const [editableItems, setEditableItems] = React.useState([]);
            const [allProducts, setAllProducts] = React.useState([]);
            const [productSearch, setProductSearch] = React.useState('');
            const [logs, setLogs] = React.useState([]);
            const [showLogs, setShowLogs] = React.useState(false);
            const [integrityIssues, setIntegrityIssues] = React.useState([]);
            
            const [notasEditables, setNotasEditables] = React.useState('');
            const [guardandoNotas, setGuardandoNotas] = React.useState(false);
            const token = localStorage.getItem('token');
            
            const fetchAllData = React.useCallback(async () => {
                setLoading(true);
                try {
                    const [pedidoRes, productsRes] = await Promise.all([
                        fetch(`${API_URL}/pedidos/${pedidoId}`, { headers: { 'Authorization': `Bearer ${token}` } }),
                        fetch(`${API_URL}/productos`, { headers: { 'Authorization': `Bearer ${token}` } })
                    ]);
        
                    if (!pedidoRes.ok) throw new Error('No se pudo obtener el detalle del pedido.');
                    if (!productsRes.ok) throw new Error('No se pudo obtener la lista de productos.');
        
                    const pedidoData = await pedidoRes.json();
                    const allProductsData = await productsRes.json();
                    
                    setPedido(pedidoData);
                    setEditableItems(pedidoData.items);
                    setAllProducts(allProductsData);
                    setNotasEditables(pedidoData.notas_entrega || '');
        
                    const issues = [];
                    const productIds = allProductsData.map(p => p.id);
                    pedidoData.items.forEach(item => {
                        if (!productIds.includes(item.producto_id)) {
                            issues.push(`El producto "${item.nombre_producto}" (ID: ${item.producto_id}) ya no existe.`);
                        }
                    });
                    setIntegrityIssues(issues);
        
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [pedidoId, token]);
            
            React.useEffect(() => {
                fetchAllData();
            }, [fetchAllData]);
        
            const fetchLogs = async () => {
                try {
                    const response = await fetch(`${API_URL}/logs`, { headers: { 'Authorization': `Bearer ${token}` } });
                    const allLogs = await response.json();
                    setLogs(allLogs.filter(log => log.detalle && log.detalle.includes(`#${pedidoId}`)));
                    setShowLogs(true);
                } catch (err) { alert("Error al cargar los logs."); }
            };
        
            const handleUpdateStatus = async (nuevoEstado) => {
                try {
                    const response = await fetch(`${API_URL}/pedidos/${pedidoId}/estado`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ estado: nuevoEstado }) });
                    if (!response.ok) throw new Error('Error al actualizar estado.');
                    onClose(); onUpdate();
                } catch(err) { alert(err.message); }
            };
            
            const handleQuantityChange = (itemId, newQuantity) => {
                const quantity = parseFloat(String(newQuantity).replace(',', '.'));
                setEditableItems(items => items.map(item => (item.id === itemId || item.producto_id === itemId) ? { ...item, cantidad: isNaN(quantity) ? 0 : quantity } : item));
            };
        
            const handleRemoveItem = (itemId) => { setEditableItems(items => items.filter(item => (item.id !== itemId && item.producto_id !== itemId))); };
            
            const handleAddItem = (productToAdd) => {
                if (productToAdd && !editableItems.find(item => item.producto_id === productToAdd.id)) {
                    const newItem = { id: `new_${productToAdd.id}`, producto_id: productToAdd.id, nombre_producto: productToAdd.nombre, cantidad: 1, precio_congelado: productToAdd.precio_unitario, aviso_faltante: productToAdd.stock === 'No', codigo_sku: productToAdd.codigo_sku };
                    setEditableItems(items => [...items, newItem]);
                }
                setProductSearch('');
            };
        
            const handleSaveChanges = async () => {
                const itemsToSave = editableItems.map(item => ({ producto_id: item.producto_id, cantidad: item.cantidad })).filter(item => item.cantidad > 0);
                try {
                    const response = await fetch(`${API_URL}/pedidos/${pedidoId}/items`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify({ items: itemsToSave }) });
                    if (!response.ok) throw new Error('Error al guardar los cambios.');
                    setIsEditing(false); onClose(); onUpdate();
                } catch (err) { alert(err.message); }
            };
            
            const handleGuardarNotas = async () => {
                setGuardandoNotas(true);
                try {
                    const response = await fetch(`${API_URL}/pedidos/${pedidoId}/notas`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ notas_entrega: notasEditables })
                    });
                    if (!response.ok) throw new Error('Error al guardar la nota.');
                    const pedidoActualizadoParcial = await response.json();
                    
                    setPedido(prevPedido => ({ ...prevPedido, notas_entrega: pedidoActualizadoParcial.notas_entrega }));
        
                } catch(err) {
                    alert(err.message);
                } finally {
                    setGuardandoNotas(false);
                }
            };
        
            const handlePrint = (printType) => {
                const printArea = document.getElementById(printType);
                const originalVis = document.body.style.visibility;
                document.body.style.visibility = 'hidden';
                printArea.style.display = 'block';
                window.print();
                printArea.style.display = 'none';
                document.body.style.visibility = originalVis;
            };
        
            const totalPedido = (pedido && editableItems) ? editableItems.reduce((acc, item) => acc + (item.cantidad * item.precio_congelado), 0) : 0;
            const isAdmin = user.rol === 'admin';
            const isDeposito = user.rol === 'deposito';
            const estadosDisponibles = isAdmin ? { pendiente: 'Pendiente', visto: 'Visto', en_preparacion: 'En Preparación', facturado: 'Facturado', listo_para_entrega: 'Listo p/ Entrega', entregado: 'Entregado', cancelado: 'Cancelado' } : { pendiente: 'Pendiente', visto: 'Visto', en_preparacion: 'En Preparación', listo_para_entrega: 'Listo p/ Entrega', entregado: 'Entregado' };
            const filteredProductsToAdd = allProducts.filter(p => productSearch && p.nombre.toLowerCase().includes(productSearch.toLowerCase()) && !editableItems.some(item => item.producto_id === p.id)).slice(0, 5);
            
            return (
                <React.Fragment>
                    <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                            <div className="flex justify-between items-center p-4 border-b">
                                <h2 className="text-xl font-bold text-gray-800">Detalle del Pedido #{pedidoId}</h2>
                                <div className="flex items-center gap-2">
                                    <button onClick={fetchLogs} className="relative flex items-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg text-sm"><HistoryIcon className="h-5 w-5"/>Logs{integrityIssues.length > 0 && <span className="absolute -top-1 -right-1 h-4 w-4 rounded-full bg-red-500 border-2 border-white"></span>}</button>
                                    <button onClick={() => handlePrint('printableAreaAssembly')} className="flex items-center gap-2 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-3 rounded-lg text-sm"><CheckSquareIcon className="h-5 w-5"/>P/ Armar</button>
                                    <button onClick={() => handlePrint('printableArea')} className="flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg text-sm"><PrintIcon className="h-5 w-5"/>Imprimir</button>
                                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-2"><CloseIcon/></button>
                                </div>
                            </div>
                            
                            {loading && <div className="p-8 flex justify-center"><Spinner className="border-blue-500"/></div>}
                            {error && <p className="p-8 text-red-500">{error}</p>}
                            
                            {!loading && !error && pedido && (
                                <div className="p-6 overflow-y-auto">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div><h3 className="font-bold text-gray-800 mb-2">Cliente</h3><p className="text-gray-600">{pedido.nombre_comercio}</p><p className="text-gray-500 text-sm">{pedido.direccion}</p></div>
                                        <div><h3 className="font-bold text-gray-800 mb-2">Información del Pedido</h3><p className="text-gray-600">Vendedor: <span className="font-semibold">{pedido.nombre_vendedor}</span></p><p className="text-gray-600">Fecha: <span className="font-semibold">{new Date(pedido.fecha_creacion).toLocaleString()}</span></p><p className="text-gray-600 flex items-center">Estado actual: <span className="ml-2"><EstadoBadge estado={pedido.estado}/></span></p></div>
                                    </div>
                                    <div className="flex justify-between items-center mb-2"><h3 className="font-bold text-gray-800">Items del Pedido</h3>{isAdmin && !isEditing && (<button onClick={() => setIsEditing(true)} className="bg-blue-100 text-blue-800 text-xs font-bold py-1 px-3 rounded-full">Editar Pedido</button>)}</div>
                                    <div className="border rounded-lg overflow-hidden mb-4">
                                        <table className="min-w-full"><thead className="bg-gray-50 text-xs uppercase"><tr><th className="px-4 py-2 text-left">Producto</th><th className="px-4 py-2 text-center">Cantidad</th><th className="px-4 py-2 text-right">Subtotal</th>{isEditing && <th className="px-4 py-2 text-right"></th>}</tr></thead>
                                            <tbody className="divide-y">{editableItems.map(item => (<tr key={item.id || item.producto_id} className={integrityIssues.some(i => i.includes(`ID: ${item.producto_id}`)) ? 'bg-red-50' : ''}>
                                                <td className="px-4 py-2 text-sm flex items-center">{item.aviso_faltante && <WarningIcon className="h-4 w-4 text-yellow-500 mr-2" title="Producto sin stock al momento del pedido"/>}{item.nombre_producto}</td>
                                                <td className="px-4 py-2 text-center text-sm">{isEditing ? <input type="number" step="0.001" value={item.cantidad} onChange={(e) => handleQuantityChange(item.id || item.producto_id, e.target.value)} className="w-20 text-center border rounded-md"/> : item.cantidad}</td>
                                                <td className="px-4 py-2 text-right text-sm font-semibold">${(item.cantidad * item.precio_congelado).toFixed(2)}</td>
                                                {isEditing && <td className="px-4 py-2 text-right"><button onClick={() => handleRemoveItem(item.id || item.producto_id)} className="text-red-500 hover:text-red-700"><TrashIcon className="h-5 w-5"/></button></td>}
                                            </tr>))}
                                            </tbody>
                                            {isEditing && <tbody><tr><td colSpan="4" className="p-2 relative"><input type="text" value={productSearch} onChange={e => setProductSearch(e.target.value)} placeholder="Buscar producto para agregar..." className="w-full p-2 border rounded-md"/>{productSearch && (<div className="absolute bg-white border shadow-lg max-h-48 overflow-y-auto w-full left-0 z-10">{filteredProductsToAdd.map(p => <div key={p.id} onClick={() => handleAddItem(p)} className="p-2 hover:bg-gray-100 cursor-pointer">{p.nombre}</div>)}</div>)}</td></tr></tbody>}
                                            {!isEditing && <tfoot className="bg-gray-50 font-bold"><tr><td colSpan="2" className="px-4 py-2 text-right">Total:</td><td className="px-4 py-2 text-right">${totalPedido.toFixed(2)}</td></tr></tfoot>}
                                        </table>
                                    </div>
                                    {isEditing && (<div className="flex justify-end gap-4"><button onClick={() => { setIsEditing(false); fetchAllData(); }} className="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button onClick={handleSaveChanges} className="bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Guardar Cambios</button></div>)}
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                        <div className="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                                            <h3 className="font-bold text-gray-800 mb-2">Notas Originales del Vendedor</h3>
                                            <p className="text-sm text-gray-700 whitespace-pre-wrap h-24 overflow-y-auto">{pedido.notas_entrega || 'No se dejaron notas.'}</p>
                                        </div>
                                        <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                            <h3 className="font-bold text-gray-800 mb-2">Notas para Impresión (Editable)</h3>
                                            <textarea value={notasEditables} onChange={(e) => setNotasEditables(e.target.value)} rows="3" className="w-full p-2 border rounded-md" placeholder="Añadir o editar notas para la impresión..."></textarea>
                                            <button onClick={handleGuardarNotas} disabled={guardandoNotas} className="mt-2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-lg text-sm disabled:bg-gray-400">{guardandoNotas ? 'Guardando...' : 'Guardar Nota'}</button>
                                        </div>
                                    </div>
        
                                    {(isAdmin || isDeposito) && !isEditing && (
                                        <div className="bg-gray-50 p-4 rounded-lg mt-4">
                                            <h3 className="font-bold text-gray-800 mb-3">Actualizar Estado</h3>
                                            <select onChange={(e) => handleUpdateStatus(e.target.value)} value={pedido.estado} className="w-full p-2 border rounded-md">{Object.entries(estadosDisponibles).map(([key, value]) => <option key={key} value={key}>{value}</option>)}</select>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    {pedido && (
                        <React.Fragment>
                            <PrintableView pedido={pedido} total={totalPedido} notasParaImprimir={notasEditables} />
                            <PrintForAssemblyView pedido={pedido} />
                        </React.Fragment>
                    )}
                </React.Fragment>
            );
        };                                            
        
        const PrintableView = ({ pedido, total, notasParaImprimir }) => {
            const formatNumber = (num) => parseFloat(Number(num).toFixed(3));
        
            return (
                <div id="printableArea" className="printable-area hidden font-sans text-black bg-white">
                    <div className="print-header">
                        <div className="flex justify-between items-start text-sm mb-4">
                            <div className="w-1/3"><h1 className="text-lg font-bold">Mayorista Comestibles</h1></div>
                            <div className="w-1/3 px-2 text-center"><h2 className="font-bold underline">Datos del Cliente</h2><p>{pedido.nombre_comercio}</p><p className="text-xs">{pedido.direccion}</p></div>
                            <div className="w-1/3 text-right"><p><span className="font-bold">Pedido N°:</span> {pedido.id}</p><p><span className="font-bold">Fecha:</span> {new Date(pedido.fecha_creacion).toLocaleDateString()}</p></div>
                        </div>
                        <hr className="border-black my-2"/>
                    </div>
                    <div className="print-body flex-grow py-4">
                        <table className="w-full text-left border-collapse mb-4 text-[10pt]">
                            <thead>
                                <tr>
                                    <th className="border-b-2 border-black p-1 text-center">Cant.</th>
                                    <th className="border-b-2 border-black p-1">Producto</th>
                                    <th className="border-b-2 border-black p-1 text-right">P. Unit</th>
                                    <th className="border-b-2 border-black p-1 text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pedido.items.map(item => (
                                    <tr key={item.id}>
                                        <td className="border-b border-gray-300 py-0.5 px-1 text-center font-bold">{formatNumber(item.cantidad)}</td>
                                        <td className="border-b border-gray-300 py-0.5 px-1">{item.nombre_producto} {item.aviso_faltante && <span className="font-bold">(S/STOCK)</span>}</td>
                                        <td className="border-b border-gray-300 py-0.5 px-1 text-right">${formatNumber(item.precio_congelado)}</td>
                                        <td className="border-b border-gray-300 py-0.5 px-1 text-right font-semibold">${formatNumber(item.cantidad * item.precio_congelado)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="print-footer flex gap-4 pt-4 mt-auto">
                        <table className="w-full">
                            <tfoot>
                                <tr>
                                    <td colSpan="3" className="font-bold text-right p-2 border-t-4 border-black">Total:</td>
                                    <td className="font-bold text-right p-2 border-t-4 border-black">${formatNumber(total)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                     <div className="print-footer flex gap-4 pt-4 mt-auto">
                        <div style={{ width: '80%' }}>
                            <h3 className="font-bold mb-1 text-sm">Notas:</h3>
                            <div className="border border-black h-24 p-1">{notasParaImprimir}</div>
                        </div>
                        <div style={{ width: '20%' }} className="flex flex-col justify-end">
                            <div className="border-b-2 border-black mt-12 mb-1"></div>
                            <p className="text-xs text-center">Firma de Conformidad</p>
                        </div>
                    </div>
                </div>
            );
        };     
                
        const PrintForAssemblyView = ({ pedido }) => {
            const formatNumber = (num) => parseFloat(Number(num).toFixed(3));
            return (
                <div id="printableAreaAssembly" className="printable-area hidden font-sans text-black bg-white" style={{ fontSize: '10pt' }}>
                    <div className="print-header flex justify-between items-center border-b-2 border-black pb-2 mb-4">
                        <h1 className="text-lg font-bold">Hoja de Armado de Pedido</h1>
                        <div>
                            <p className="font-semibold">{pedido.nombre_comercio}</p>
                            <p className="text-sm">Pedido N°: <span className="font-bold">{pedido.id}</span></p>
                        </div>
                    </div>
                    <div className="print-body">
                        <table className="w-full">
                            <thead>
                                <tr>
                                    <th className="border-b-2 border-black p-1 text-center w-16">Listo</th>
                                    <th className="border-b-2 border-black p-1 text-center w-24">Cantidad</th>
                                    <th className="border-b-2 border-black p-1 text-left">Producto</th>
                                </tr>
                            </thead>
                            <tbody>
                                {pedido.items.map(item => (
                                    <tr key={item.id} className="border-b border-gray-300">
                                        <td className="p-2 text-center"><input type="checkbox" style={{ width: '20px', height: '20px' }} /></td>
                                        <td className="p-2 text-center font-bold text-lg">{formatNumber(item.cantidad)}</td>
                                        <td className="p-2">{item.nombre_producto}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        const ProductoFormModal = ({ producto, onClose, onSuccess }) => {
            const [formData, setFormData] = React.useState({ codigo_sku: '', nombre: '', descripcion: '', precio_unitario: '', stock: 'Sí', imagen_url: '' });
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');
            const isEditing = producto && producto.id;

            React.useEffect(() => { 
                if (isEditing) { 
                    setFormData({ codigo_sku: producto.codigo_sku || '', nombre: producto.nombre || '', descripcion: producto.descripcion || '', precio_unitario: producto.precio_unitario || '', stock: producto.stock || 'Sí', imagen_url: producto.imagen_url || '' }); 
                } else {
                    setFormData({ codigo_sku: '', nombre: '', descripcion: '', precio_unitario: '', stock: 'Sí', imagen_url: '' });
                }
            }, [producto, isEditing]);

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = async (e) => {
                e.preventDefault(); setLoading(true); setError(null);
                const url = isEditing ? `${API_URL}/productos/${producto.id}` : `${API_URL}/productos`;
                const method = isEditing ? 'PUT' : 'POST';
                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(formData) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al guardar el producto.');
                    onSuccess();
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Producto' : 'Agregar Producto'}</h2><button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button></div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <div><label htmlFor="nombre" className="block text-sm font-medium text-gray-700">Nombre del Producto</label><input type="text" name="nombre" id="nombre" value={formData.nombre} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500" required /></div>
                            <div><label htmlFor="imagen_url" className="block text-sm font-medium text-gray-700">URL de la Imagen</label><input type="text" name="imagen_url" id="imagen_url" value={formData.imagen_url} onChange={handleChange} placeholder="https://ejemplo.com/imagen.jpg" className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div><label htmlFor="precio_unitario" className="block text-sm font-medium text-gray-700">Precio</label><input type="number" name="precio_unitario" id="precio_unitario" value={formData.precio_unitario} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required /></div>
                                <div><label htmlFor="stock" className="block text-sm font-medium text-gray-700">Stock</label><select name="stock" id="stock" value={formData.stock} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"><option>Sí</option><option>No</option></select></div>
                            </div>
                            <div><label htmlFor="codigo_sku" className="block text-sm font-medium text-gray-700">SKU (Código Interno)</label><input type="text" name="codigo_sku" id="codigo_sku" value={formData.codigo_sku} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div>
                            <div><label htmlFor="descripcion" className="block text-sm font-medium text-gray-700">Descripción</label><textarea name="descripcion" id="descripcion" rows="3" value={formData.descripcion} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3"></textarea></div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">{error && <p className="text-red-500 text-sm">{error}</p>}<button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">{loading ? 'Guardando...' : 'Guardar Producto'}</button></div>
                    </form>
                </div>
            );
        };
        const ClienteFormModal = ({ cliente, onClose, onSuccess }) => {
            const [formData, setFormData] = React.useState({ nombre_comercio: '', nombre_contacto: '', direccion: '', telefono: '' });
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');
            const isEditing = cliente && cliente.id;

            React.useEffect(() => { 
                if (isEditing) { 
                    setFormData({ nombre_comercio: cliente.nombre_comercio || '', nombre_contacto: cliente.nombre_contacto || '', direccion: cliente.direccion || '', telefono: cliente.telefono || '' }); 
                } else {
                    setFormData({ nombre_comercio: '', nombre_contacto: '', direccion: '', telefono: '' });
                }
            }, [cliente, isEditing]);

            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };
            const handleSubmit = async (e) => {
                e.preventDefault(); setLoading(true); setError(null);
                const url = isEditing ? `${API_URL}/clientes/${cliente.id}` : `${API_URL}/clientes`;
                const method = isEditing ? 'PUT' : 'POST';
                try {
                    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(formData) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al guardar el cliente.');
                    onSuccess();
                } catch (err) { setError(err.message); } finally { setLoading(false); }
            };
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Cliente' : 'Agregar Cliente'}</h2><button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button></div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <div><label htmlFor="nombre_comercio" className="block text-sm font-medium text-gray-700">Nombre del Comercio</label><input type="text" name="nombre_comercio" id="nombre_comercio" value={formData.nombre_comercio} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required /></div>
                            <div><label htmlFor="nombre_contacto" className="block text-sm font-medium text-gray-700">Nombre del Contacto</label><input type="text" name="nombre_contacto" id="nombre_contacto" value={formData.nombre_contacto} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div>
                            <div><label htmlFor="direccion" className="block text-sm font-medium text-gray-700">Dirección</label><input type="text" name="direccion" id="direccion" value={formData.direccion} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div>
                            <div><label htmlFor="telefono" className="block text-sm font-medium text-gray-700">Teléfono</label><input type="text" name="telefono" id="telefono" value={formData.telefono} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" /></div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">{error && <p className="text-red-500 text-sm">{error}</p>}<button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button><button type="submit" disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">{loading ? 'Guardando...' : 'Guardar Cliente'}</button></div>
                    </form>
                </div>
            );
        };
        
        const UsuarioFormModal = ({ usuario, onClose, onSuccess }) => {
            const [formData, setFormData] = React.useState({ nombre: '', email: '', password: '', rol: 'vendedor' });
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');
            const isEditing = usuario && usuario.id;

            React.useEffect(() => {
                if (isEditing) {
                    setFormData({
                        nombre: usuario.nombre || '',
                        email: usuario.email || '',
                        password: '',
                        rol: usuario.rol || 'vendedor'
                    });
                } else {
                    setFormData({ nombre: '', email: '', password: '', rol: 'vendedor' });
                }
            }, [usuario, isEditing]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);

                const url = isEditing ? `${API_URL}/usuarios/${usuario.id}` : `${API_URL}/usuarios`;
                const method = isEditing ? 'PUT' : 'POST';
                
                const body = { ...formData };
                if (body.password === '') {
                    delete body.password;
                }

                try {
                    const response = await fetch(url, {
                        method,
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al guardar el usuario.');
                    onSuccess();
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">{isEditing ? 'Editar Usuario' : 'Agregar Usuario'}</h2>
                            <button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <div>
                                <label htmlFor="nombre" className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                                <input type="text" name="nombre" id="nombre" value={formData.nombre} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required />
                            </div>
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                                <input type="email" name="email" id="email" value={formData.email} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" required />
                            </div>
                            <div>
                                <label htmlFor="password" className="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input type="password" name="password" id="password" value={formData.password} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3" placeholder={isEditing ? "Dejar en blanco para no cambiar" : ""} />
                            </div>
                             <div>
                                <label htmlFor="rol" className="block text-sm font-medium text-gray-700">Rol</label>
                                <select name="rol" id="rol" value={formData.rol} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                                    <option value="vendedor">Vendedor</option>
                                    <option value="deposito">Depósito</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cancelar</button>
                            <button type="submit" disabled={loading} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center">{loading ? 'Guardando...' : 'Guardar Usuario'}</button>
                        </div>
                    </form>
                </div>
            );
        };

        const ImportModal = ({ onClose, onSuccess }) => {
            const [file, setFile] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [report, setReport] = React.useState(null);
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');

            const handleFileChange = (e) => {
                setFile(e.target.files[0]);
                setReport(null);
                setError(null);
            };

            const ImportVentasModal = ({ onClose }) => {
            const [file, setFile] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [message, setMessage] = React.useState('');
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!file) { setError('Por favor, selecciona un archivo CSV.'); return; }
                setLoading(true); setError(null); setMessage('');

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_URL}/import/ventas-presenciales`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al importar archivo.');
                    setMessage(data.message);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-lg">
                        <div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">Importar Ventas Presenciales (CSV)</h2><button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button></div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <p className="text-sm text-gray-600">Selecciona el archivo CSV exportado desde el sistema de ventas presencial.</p>
                            <input type="file" accept=".csv" onChange={e => setFile(e.target.files[0])} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                             {message && <p className="p-3 bg-green-100 text-green-800 rounded-md">{message}</p>}
                             {error && <p className="p-3 bg-red-100 text-red-800 rounded-md">{error}</p>}
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                            <button type="submit" disabled={loading || !file} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center disabled:bg-gray-400">
                                {loading ? 'Importando...' : 'Importar Ventas'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!file) {
                    setError('Por favor, selecciona un archivo CSV.');
                    return;
                }
                setLoading(true);
                setError(null);
                setReport(null);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_URL}/productos/import`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al importar archivo.');
                    
                    setReport(data);
                    onSuccess(); 

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b"><h2 className="text-xl font-bold text-gray-800">Importar Productos desde CSV</h2><button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button></div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <p className="text-sm text-gray-600">Selecciona un archivo CSV. Las columnas necesarias son <b>A_COD</b> (SKU), <b>A_DET</b> (Nombre) y <b>A_PLIS1</b> (Precio).</p>
                            <input type="file" accept=".csv" onChange={handleFileChange} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"/>
                            
                            {loading && <div className="flex items-center gap-2 text-blue-600"><Spinner className="border-blue-600"/> <p>Procesando archivo, por favor espera...</p></div>}
                            {error && <p className="p-3 bg-red-100 text-red-800 rounded-md">{error}</p>}
                            {report && (
                                <div className="mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
                                    <h3 className="font-bold text-lg text-gray-800">{report.message}</h3>
                                    <div className="grid grid-cols-3 gap-4 text-center">
                                        <div className="p-2 bg-green-100 rounded-md"><p className="text-2xl font-bold text-green-800">{report.creados}</p><p className="text-sm text-green-700">Creados</p></div>
                                        <div className="p-2 bg-blue-100 rounded-md"><p className="text-2xl font-bold text-blue-800">{report.actualizados}</p><p className="text-sm text-blue-700">Actualizados</p></div>
                                        <div className="p-2 bg-yellow-100 rounded-md"><p className="text-2xl font-bold text-yellow-800">{report.filasOmitidas}</p><p className="text-sm text-yellow-700">Omitidos</p></div>
                                    </div>
                                    {report.errores && report.errores.length > 0 && (
                                        <div>
                                            <h4 className="font-semibold text-gray-700">Detalle de filas omitidas:</h4>
                                            <ul className="text-xs text-red-700 list-disc list-inside max-h-32 overflow-y-auto">
                                                {report.errores.map(e => <li key={e.fila}><b>Fila {e.fila}:</b> {e.error}</li>)}
                                            </ul>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                            <button type="submit" disabled={loading || !file} className="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg flex items-center disabled:bg-gray-400">
                                {loading ? 'Importando...' : 'Importar Archivo'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

         const ImportVentasModal = ({ onClose, onSuccess }) => {
            const [file, setFile] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [report, setReport] = React.useState(null);
            const [error, setError] = React.useState(null);
            const token = localStorage.getItem('token');

            const handleFileChange = (e) => {
                setFile(e.target.files[0]);
                setReport(null);
                setError(null);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!file) {
                    setError('Por favor, selecciona un archivo CSV.');
                    return;
                }
                setLoading(true);
                setError(null);
                setReport(null);

                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${API_URL}/import/ventas-presenciales`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al importar el archivo.');
                    
                    setReport(data);
                    onSuccess();

                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                 <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
                    <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center p-4 border-b">
                            <h2 className="text-xl font-bold text-gray-800">Importar Ventas Presenciales (CSV)</h2>
                            <button type="button" onClick={onClose} className="text-gray-400 hover:text-gray-600"><CloseIcon/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-4">
                            <p className="text-sm text-gray-600">Selecciona el archivo CSV exportado desde el sistema de ventas. El sistema evitará duplicar ventas con el mismo número de comprobante.</p>
                            <input type="file" accept=".csv" onChange={handleFileChange} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                            
                            {loading && <div className="flex items-center gap-2 text-blue-600"><Spinner className="border-blue-600"/> <p>Procesando archivo, por favor espera...</p></div>}
                            {error && <p className="p-3 bg-red-100 text-red-800 rounded-md">{error}</p>}
                            {report && (
                                <div className="mt-4 p-4 bg-gray-50 rounded-lg space-y-3">
                                    <h3 className="font-bold text-lg text-green-800">{report.message}</h3>
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t bg-gray-50 flex justify-end items-center gap-4">
                            <button type="button" onClick={onClose} className="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Cerrar</button>
                            <button type="submit" disabled={loading || !file} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center disabled:bg-gray-400">
                                {loading ? 'Importando...' : 'Importar Archivo'}
                            </button>
                        </div>
                    </form>
                </div>
            );
        };

        const DashboardPage = ({ user, onLogout, currentPage, setCurrentPage, onShowPedido, onShowProductoForm, onShowClienteForm, onShowImportModal, onShowUsuarioForm, onShowImportVentasModal }) => {
            const isAdmin = user.rol === 'admin';
            
            const renderContent = () => {
                switch (currentPage) {
                    case 'pedidos': 
                        return <PedidosView onSelectPedido={onShowPedido} user={user} />;
                    case 'productos': 
                        return <ProductosView user={user} onShowProductoForm={onShowProductoForm} onShowImportModal={onShowImportModal} />;
                    case 'clientes': 
                        return <ClientesView user={user} onShowClienteForm={onShowClienteForm} />;
                    case 'usuarios': 
                        return <UsuariosView onShowUsuarioForm={onShowUsuarioForm} />;
                    case 'actividad': 
                        return <ActividadView />;
                    case 'dashboard': 
                    default:
                        return <DashboardView onShowImportVentasModal={onShowImportVentasModal} />;
                }
            };

            return (
                <div className="flex h-screen bg-gray-100 font-sans">
                    <aside className="w-64 bg-gray-800 text-white flex flex-col shrink-0">
                        <div className="h-20 flex items-center justify-center border-b border-gray-700"><PackageIcon className="h-8 w-8 mr-2" /><span className="text-xl font-bold">Distribuidora</span></div>
                        <nav className="flex-1 px-4 py-6 space-y-2">
                            <NavItem icon={<HomeIcon />} text="Dashboard" active={currentPage === 'dashboard'} onClick={() => setCurrentPage('dashboard')} />
                            <NavItem icon={<ShoppingCartIcon />} text="Pedidos" active={currentPage === 'pedidos'} onClick={() => setCurrentPage('pedidos')} />
                            <NavItem icon={<PackageIcon />} text="Productos" active={currentPage === 'productos'} onClick={() => setCurrentPage('productos')} />
                            <NavItem icon={<UsersIcon />} text="Clientes" active={currentPage === 'clientes'} onClick={() => setCurrentPage('clientes')} />
                            {isAdmin && <NavItem icon={<UsersIcon />} text="Usuarios" active={currentPage === 'usuarios'} onClick={() => setCurrentPage('usuarios')} />}
                            {isAdmin && <NavItem icon={<ActivityIcon />} text="Actividad" active={currentPage === 'actividad'} onClick={() => setCurrentPage('actividad')} />}
                        </nav>
                        <div className="px-4 py-6 border-t border-gray-700">
                            <div className="mb-4"><p className="text-sm font-semibold">{user.nombre}</p><p className="text-xs text-gray-400 capitalize">{user.rol}</p></div>
                            <button onClick={onLogout} className="w-full flex items-center justify-center py-2 px-4 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold"><LogOutIcon className="h-5 w-5 mr-2" />Cerrar Sesión</button>
                        </div>
                    </aside>
                    <main className="flex-1 p-8 overflow-y-auto">{renderContent()}</main>
                </div>
            );
        };

       function App() {
            const [currentPage, setCurrentPage] = React.useState('dashboard');
            const [token, setToken] = React.useState(localStorage.getItem('token'));
            const [user, setUser] = React.useState(JSON.parse(localStorage.getItem('user')));
            const [loading, setLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [viewingPedidoId, setViewingPedidoId] = React.useState(null);
            const [editingProducto, setEditingProducto] = React.useState(null);
            const [editingCliente, setEditingCliente] = React.useState(null);
            const [editingUsuario, setEditingUsuario] = React.useState(null);
            const [isImportModalOpen, setIsImportModalOpen] = React.useState(false);
            const [isImportVentasModalOpen, setIsImportVentasModalOpen] = React.useState(false);
        
            const handleLogin = React.useCallback(async (email, password) => {
                setLoading(true); setError(null);
                try {
                    const response = await fetch(`${API_URL}/auth/login`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ email, password }) 
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Error al iniciar sesión.');
                    localStorage.setItem('token', data.token); 
                    localStorage.setItem('user', JSON.stringify(data.user));
                    setToken(data.token); 
                    setUser(data.user);
                } catch (err) { 
                    setError(err.message); 
                } finally { 
                    setLoading(false); 
                }
            }, []);
        
            const handleLogout = React.useCallback(() => {
                localStorage.removeItem('token'); 
                localStorage.removeItem('user');
                setToken(null); 
                setUser(null); 
                setViewingPedidoId(null); 
                setEditingProducto(null); 
                setEditingCliente(null); 
                setEditingUsuario(null);
            }, []);
        
            const forceRerender = (page) => {
                setCurrentPage('');
                setTimeout(() => setCurrentPage(page), 0);
            };
        
            if (!token || !user) {
                return <LoginPage onLogin={handleLogin} loading={loading} error={error} />;
            }
        
            if (user.rol !== 'admin' && user.rol !== 'deposito') {
                handleLogout();
                return <LoginPage onLogin={handleLogin} loading={false} error="No tienes permiso para acceder a este panel." />;
            }
        
            return (
                <React.Fragment>
                    <DashboardPage
                        user={user}
                        onLogout={handleLogout}
                        currentPage={currentPage}
                        setCurrentPage={setCurrentPage}
                        onShowPedido={setViewingPedidoId}
                        onShowProductoForm={setEditingProducto}
                        onShowClienteForm={setEditingCliente}
                        onShowImportModal={() => setIsImportModalOpen(true)}
                        onShowUsuarioForm={setEditingUsuario}
                        onShowImportVentasModal={() => setIsImportVentasModalOpen(true)}
                    />
                    {viewingPedidoId && (
                        <PedidoDetailModal
                            pedidoId={viewingPedidoId}
                            onClose={() => setViewingPedidoId(null)}
                            user={user}
                            onUpdate={() => forceRerender('pedidos')}
                        />
                    )}
                    {editingProducto !== null && (
                        <ProductoFormModal
                            producto={editingProducto}
                            onClose={() => setEditingProducto(null)}
                            onSuccess={() => { setEditingProducto(null); forceRerender('productos'); }}
                        />
                    )}
                    {editingCliente !== null && (
                        <ClienteFormModal
                            cliente={editingCliente}
                            onClose={() => setEditingCliente(null)}
                            onSuccess={() => { setEditingCliente(null); forceRerender('clientes'); }}
                        />
                    )}
                    {editingUsuario !== null && (
                        <UsuarioFormModal 
                            usuario={editingUsuario} 
                            onClose={() => setEditingUsuario(null)} 
                            onSuccess={() => { setEditingUsuario(null); forceRerender('usuarios'); }} 
                        />
                    )}
                    {isImportModalOpen && (
                        <ImportModal
                            onClose={() => setIsImportModalOpen(false)}
                            onSuccess={() => forceRerender('productos')}
                        />
                    )}
                    {isImportVentasModalOpen && (
                        <ImportVentasModal 
                            onClose={() => { setIsImportVentasModalOpen(false); forceRerender('dashboard'); }} 
                        />
                    )}
                </React.Fragment>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
